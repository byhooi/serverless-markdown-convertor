name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©8ç‚¹
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    name: Sync latest commits from upstream repo

    steps:
    - name: Checkout target repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Sync Upstream
      uses: actions/github-script@v6
      with:
        script: |
          // ğŸ‘‡ 1. è®¾ç½®ä¸Šæ¸¸ä»“åº“åœ°å€
          const upstream_repo = "xxnuo/serverless-markdown-convertor";
          
          // ğŸ‘‡ 2. è®¾ç½®åˆ†æ”¯
          const branch = "main"; 

          try {
            // ä¿®æ­£ï¼šåˆ é™¤äº†æŠ¥é”™çš„ require è¯­å¥
            // exec å·¥å…·æ˜¯å†…ç½®çš„ï¼Œç›´æ¥ä½¿ç”¨å³å¯

            // é…ç½®èº«ä»½
            await exec.exec("git config --global user.name 'GitHub Actions'");
            await exec.exec("git config --global user.email 'actions@github.com'");

            // æ·»åŠ ä¸Šæ¸¸å¹¶è·å–æ›´æ–°
            await exec.exec(`git remote add upstream https://github.com/${upstream_repo}.git`);
            await exec.exec("git fetch upstream");

            // ç¡®ä¿åˆ‡æ¢åˆ° main åˆ†æ”¯
            await exec.exec(`git checkout ${branch}`);

            // âš¡ï¸ éœ¸é“åˆå¹¶æ¨¡å¼
            try {
              console.log("å°è¯•åˆå¹¶ä¸Šæ¸¸ä»£ç ...");
              // -X theirs: é‡åˆ°å†²çªæ—¶ï¼Œæ— æ¡ä»¶ä½¿ç”¨ä¸Šæ¸¸ä½œè€…çš„ç‰ˆæœ¬
              // --allow-unrelated-histories: å…è®¸åˆå¹¶å†å²ä¸ç›¸å…³çš„ä»“åº“
              await exec.exec(`git merge upstream/${branch} -X theirs --allow-unrelated-histories --no-edit`);
            } catch (error) {
              console.error("åˆå¹¶ä¾ç„¶å¤±è´¥ï¼Œæ­£åœ¨è¾“å‡ºè¯¦ç»†æ—¥å¿—...");
              await exec.exec("git status");
              throw error;
            }

            // æ¨é€
            await exec.exec("git push origin");
            console.log("âœ… åŒæ­¥æˆåŠŸï¼");
            
          } catch (error) {
            console.error("âŒ åŒæ­¥å¤±è´¥:", error);
            core.setFailed(error.message);
          }
