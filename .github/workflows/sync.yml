name: Upstream Sync

permissions:
  contents: write

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©8ç‚¹
  workflow_dispatch:

jobs:
  sync_latest_from_upstream:
    runs-on: ubuntu-latest
    name: Sync latest commits from upstream repo

    steps:
    - name: Checkout target repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Sync Upstream
      uses: actions/github-script@v6
      with:
        script: |
          // ğŸ‘‡ 1. è®¾ç½®ä¸Šæ¸¸ä»“åº“åœ°å€
          const upstream_repo = "xxnuo/serverless-markdown-convertor";
          
          // ğŸ‘‡ 2. è®¾ç½®åˆ†æ”¯ (ä½ è¿™ä¸ªä»“åº“é»˜è®¤æ˜¯ main)
          const branch = "main"; 

          try {
            // âŒ åˆ é™¤äº†æŠ¥é”™çš„ require è¡Œï¼Œç›´æ¥ä½¿ç”¨å†…ç½®çš„ exec
            
            // é…ç½®æœºå™¨äººèº«ä»½
            await exec.exec("git config --global user.name 'GitHub Actions'");
            await exec.exec("git config --global user.email 'actions@github.com'");

            // æ‹‰å–ä¸Šæ¸¸ä»£ç 
            await exec.exec(`git remote add upstream https://github.com/${upstream_repo}.git`);
            await exec.exec("git fetch upstream");

            // ç¡®ä¿åˆ‡æ¢åˆ° main åˆ†æ”¯
            await exec.exec(`git checkout ${branch}`);

            // å°è¯•åˆå¹¶ (è¿™æ­¥ä¼šä¿ç•™ä½ çš„ sync.yml)
            try {
              await exec.exec(`git merge upstream/${branch} --no-edit`);
            } catch (error) {
              console.log("âš ï¸ Merge å†²çªï¼Œå°è¯•è‡ªåŠ¨è§£å†³...");
              // è¿™é‡Œçš„ throw ä¼šè¢«å¤–å±‚æ•è·å¹¶æŠ¥å‘Šå¤±è´¥
              throw error;
            }

            // æ¨é€
            await exec.exec("git push origin");
            console.log("âœ… åŒæ­¥æˆåŠŸï¼");
            
          } catch (error) {
            console.error("âŒ åŒæ­¥å¤±è´¥:", error);
            core.setFailed(error.message);
          }
